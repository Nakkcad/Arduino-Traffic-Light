<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Light Controller</title>
    <link rel="stylesheet" href="/templates/style.css">
</head>
<body>
    <div class="sidebar">
        <div class="controls">
            <button id="pauseBtn">Pause</button>
            <button id="resumeBtn">Resume</button>
            <button id="statusBtn">Status</button>
        </div>
        <div class="delay-inputs">
            <h3>Light Delays (ms)</h3>
            <form id="delayForm">
                <div>
                    <strong>NORTH:</strong><br>
                    <input type="number" name="NORTH_R" placeholder="Red" min="500" style="width:45px;" value="5000" step="500">
                    <input type="number" name="NORTH_Y" placeholder="Yellow" min="500" style="width:45px;" value="2000" step="500">
                    <input type="number" name="NORTH_G" placeholder="Green" min="500" style="width:45px;" value="5000" step="500">
                </div>
                <div>
                    <strong>NE:</strong><br>
                    <input type="number" name="NE_R" placeholder="Red" min="500" style="width:45px;" value="5000" step="500">
                    <input type="number" name="NE_Y" placeholder="Yellow" min="500" style="width:45px;" value="2000" step="500">
                    <input type="number" name="NE_G" placeholder="Green" min="500" style="width:45px;" value="5000" step="500">
                </div>
                <div>
                    <strong>SE:</strong><br>
                    <input type="number" name="SE_R" placeholder="Red" min="500" style="width:45px;" value="5000" step="500">
                    <input type="number" name="SE_Y" placeholder="Yellow" min="500" style="width:45px;" value="2000" step="500">
                    <input type="number" name="SE_G" placeholder="Green" min="500" style="width:45px;" value="5000" step="500">
                </div>
                <div>
                    <strong>SW:</strong><br>
                    <input type="number" name="SW_R" placeholder="Red" min="500" style="width:45px;" value="5000" step="500">
                    <input type="number" name="SW_Y" placeholder="Yellow" min="500" style="width:45px;" value="2000" step="500">
                    <input type="number" name="SW_G" placeholder="Green" min="500" style="width:45px;" value="5000" step="500">
                </div>
                <div>
                    <strong>NW:</strong><br>
                    <input type="number" name="NW_R" placeholder="Red" min="500" style="width:45px;" value="5000" step="500">
                    <input type="number" name="NW_Y" placeholder="Yellow" min="500" style="width:45px;" value="2000" step="500">
                    <input type="number" name="NW_G" placeholder="Green" min="500" style="width:45px;" value="5000" step="500">
                </div>
                <button type="submit" style="margin-top:8px;">Set Delays</button>
            </form>
        </div>
        <div class="order-inputs">
            <h3 style="margin-top:0;">Light Order</h3>
            <div id="orderBlocks" style="display:flex; flex-direction:column; gap:8px;">
                <div class="order-block" draggable="true" data-dir="NORTH">NORTH</div>
                <div class="order-block" draggable="true" data-dir="NE">NE</div>
                <div class="order-block" draggable="true" data-dir="SE">SE</div>
                <div class="order-block" draggable="true" data-dir="SW">SW</div>
                <div class="order-block" draggable="true" data-dir="NW">NW</div>
            </div>
            <button id="setOrderBtn" style="margin-top:12px;">Set Order</button>
        </div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <h1>Traffic Light Controller</h1>
        <div class="container">
            <!-- Traffic lights will be generated here -->
        </div>
    </div>
    <div class="serial-view">
        <h3>Serial Monitor</h3>
        <button id="serialRefreshBtn" style="margin-bottom:8px;">Refresh</button>
        <div id="serialMonitor" style="height:320px;overflow:auto;background:#222;color:#eee;padding:12px;border-radius:8px;font-family:monospace;font-size:14px;box-shadow:0 2px 8px #ccc; white-space: pre-wrap;"></div>
        <div style="margin-top:12px;">
            <textarea id="serialCommandInput" rows="2" style="width:100%;resize:vertical;font-family:monospace;font-size:14px;padding:6px;border-radius:6px;border:1px solid #bbb;" placeholder="Type command here..."></textarea>
            <button id="serialSendBtn" style="margin-top:6px;width:100%;">Send Command</button>
        </div>
    </div>
    <div class="state-log" id="stateLog">
        <h4>State Log</h4>
        <div id="stateLogEntries"></div>
    </div>
    <div class="dark-toggle">
        <button id="darkModeBtn" title="Toggle dark mode">ðŸŒ™ Dark Mode</button>
    </div>
    <div class="manual-toggle" style="position: fixed; left: 24px; bottom: 72px; z-index: 102;">
        <button id="manualModeBtn" title="Toggle manual mode" style="padding:12px 20px; border-radius:12px; border:none; background:#1976d2; color:#fff; font-weight:bold; cursor:pointer; box-shadow:0 2px 12px #222; font-size:16px; margin-bottom:8px;">
            ðŸ”„ Auto Mode
        </button>
        <div id="manualControls" style="display:none; background:#fff; border-radius:12px; box-shadow:0 2px 12px #ccc; padding:12px; margin-top:8px;">
            <label for="manualDelay"><strong>Delay (ms):</strong></label>
            <input type="number" id="manualDelay" min="500" value="10000" style="width:70px; margin-bottom:8px;">
            <div id="manualLights" style="display:flex; flex-direction:column; gap:6px; margin-top:8px;">
                <!-- Manual light toggles will be generated here -->
            </div>
            <button id="manualSendBtn" style="margin-top:8px;width:100%;">Send Manual Command</button>
        </div>
    </div>

    <script>
        // Light configuration matching Arduino code
        // Center at (300, 300), radius 220 for more spacing
        const directions = [
            { name: 'NORTH', x: 300, y: 80 },
            { name: 'NE',   x: 480, y: 230 },
            { name: 'SE',   x: 420, y: 480 },
            { name: 'SW',   x: 180, y: 480 },
            { name: 'NW',   x: 120, y: 230 }
        ];
        const container = document.querySelector('.container');

        // Create traffic light elements at pentagon vertices
        directions.forEach(dir => {
            const lightDiv = document.createElement('div');
            lightDiv.className = 'traffic-light';
            lightDiv.id = dir.name.toLowerCase();
            lightDiv.style.left = `${dir.x - 10}px`; // Center the light
            lightDiv.style.top = `${dir.y - 50}px`;
            lightDiv.innerHTML = `
                <div style="text-align:center;font-weight:bold;">${dir.name}</div>
                <div class="light red"></div>
                <div class="light yellow"></div>
                <div class="light green"></div>
            `;
            container.appendChild(lightDiv);
        });

        // Control buttons
        document.getElementById('pauseBtn').addEventListener('click', () => {
            sendCommand('!pause');
        });
        
        document.getElementById('resumeBtn').addEventListener('click', () => {
            sendCommand('!resume');
        });
        
        document.getElementById('statusBtn').addEventListener('click', () => {
            sendCommand('!status');
        });

        document.getElementById('delayForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // Gather delay values in order: NORTH, NE, SE, SW, NW (Red, Yellow, Green for each)
            const order = ['NORTH', 'NE', 'SE', 'SW', 'NW'];
            let delays = [];
            order.forEach(dir => {
                delays.push(document.querySelector(`[name="${dir}_R"]`).value || 5000);
                delays.push(document.querySelector(`[name="${dir}_Y"]`).value || 2000);
                delays.push(document.querySelector(`[name="${dir}_G"]`).value || 5000);
            });
            // Create the command string
const delayCommand = '!delay ' + delays.join(',');

// Log it to console
console.log("Sending delay command:", delayCommand);

// Send to backend
sendCommand(delayCommand);
        });

        // Drag & drop logic for order blocks
        const orderBlocks = document.getElementById('orderBlocks');
        let draggedBlock = null;

        orderBlocks.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('order-block')) {
                draggedBlock = e.target;
                e.target.classList.add('dragging');
            }
        });
        orderBlocks.addEventListener('dragend', function(e) {
            if (draggedBlock) {
                draggedBlock.classList.remove('dragging');
                draggedBlock = null;
            }
        });
        orderBlocks.addEventListener('dragover', function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(orderBlocks, e.clientY);
            if (draggedBlock && afterElement) {
                orderBlocks.insertBefore(draggedBlock, afterElement);
            } else if (draggedBlock) {
                orderBlocks.appendChild(draggedBlock);
            }
        });
        function getDragAfterElement(container, y) {
            const blocks = [...container.querySelectorAll('.order-block:not(.dragging)')];
            return blocks.find(block => {
                const rect = block.getBoundingClientRect();
                return y < rect.top + rect.height / 2;
            });
        }

        // Set order button
        document.getElementById('setOrderBtn').addEventListener('click', function() {
            // Get current order as indices for Arduino
            const dirToIndex = { 'NORTH': 0, 'NE': 1, 'SE': 2, 'SW': 3, 'NW': 4 };
            const order = Array.from(orderBlocks.children).map(block => dirToIndex[block.dataset.dir]);
            if (order.length === 5) {
                sendCommand('!order ' + order.join(','));
            }
        });

        function sendCommand(cmd) {
            fetch('/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({command: cmd})
            })
            .then(response => response.json())
            .then(data => console.log('Command response:', data))
            .catch(error => console.error('Error sending command:', error));
        }

        function updateLights() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Reset all lights first
                    document.querySelectorAll('.light').forEach(light => {
                        light.classList.remove('active');
                    });

                    // Update each direction's lights, ignore STATE
                    for (const [direction, states] of Object.entries(data)) {
                        if (direction === 'STATE') {
                            logState(states);
                            continue;
                        }
                        const element = document.getElementById(direction.toLowerCase());
                        if (element) {
                            if (states.RED) element.querySelector('.red').classList.add('active');
                            if (states.YELLOW) element.querySelector('.yellow').classList.add('active');
                            if (states.GREEN) element.querySelector('.green').classList.add('active');
                        }
                    }
                })
                .catch(error => console.error('Error fetching light status:', error));
        }

        // Log STATE messages to the bottom right panel
        function logState(stateValue) {
            const logEntries = document.getElementById('stateLogEntries');
            const wasAtBottom = Math.abs(logEntries.scrollTop + logEntries.clientHeight - logEntries.scrollHeight) < 4;
            const entry = document.createElement('div');
            entry.className = 'state-log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] STATE: ${stateValue}`;
            logEntries.appendChild(entry);
            // Keep only last 20 entries
            while (logEntries.children.length > 20) {
                logEntries.removeChild(logEntries.firstChild);
            }
            // Only auto-scroll if user was at the bottom before adding
            if (wasAtBottom) {
                logEntries.scrollTop = logEntries.scrollHeight;
            }
        }

        // Serial view logic
        function updateSerialView() {
            fetch('/serial')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('serialMonitor').textContent = data;
                })
                .catch(error => {
                    document.getElementById('serialMonitor').textContent = 'Error loading serial data';
                });
        }
        document.getElementById('serialRefreshBtn').addEventListener('click', updateSerialView);
        setInterval(updateSerialView, 1000);
        updateSerialView();

        // Update every 500ms and immediately on load
        setInterval(updateLights, 500);
        updateLights();

        // Dark mode toggle logic
        const darkModeBtn = document.getElementById('darkModeBtn');
        function setDarkMode(enabled) {
            document.body.classList.toggle('dark-mode', enabled);
            localStorage.setItem('darkMode', enabled ? '1' : '0');
            darkModeBtn.textContent = enabled ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
        }
        darkModeBtn.addEventListener('click', () => {
            setDarkMode(!document.body.classList.contains('dark-mode'));
        });
        // On load, restore dark mode from localStorage
        setDarkMode(localStorage.getItem('darkMode') === '1');

        // Manual mode logic
let manualMode = false;
const manualModeBtn = document.getElementById('manualModeBtn');
const manualControls = document.getElementById('manualControls');
const manualLightsDiv = document.getElementById('manualLights');
const manualDelayInput = document.getElementById('manualDelay');
const manualSendBtn = document.getElementById('manualSendBtn');

// Each direction has 3 lights: RED, YELLOW, GREEN (order: NORTH, NE, SE, SW, NW)
const manualLightOrder = [
    { dir: 'NORTH', lights: ['RED', 'YELLOW', 'GREEN'] },
    { dir: 'NE',    lights: ['RED', 'YELLOW', 'GREEN'] },
    { dir: 'SE',    lights: ['RED', 'YELLOW', 'GREEN'] },
    { dir: 'SW',    lights: ['RED', 'YELLOW', 'GREEN'] },
    { dir: 'NW',    lights: ['RED', 'YELLOW', 'GREEN'] }
];
// 15 bits: [NORTH_R, NORTH_Y, NORTH_G, NE_R, NE_Y, NE_G, ...]
let manualStates = Array(15).fill(0);

// Generate manual light toggles
function renderManualLights() {
    manualLightsDiv.innerHTML = '';
    manualLightOrder.forEach((item, dIdx) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.innerHTML = `<strong style="width:60px;">${item.dir}:</strong>`;
        item.lights.forEach((light, lIdx) => {
            const idx = dIdx * 3 + lIdx;
            const btn = document.createElement('button');
            btn.textContent = light[0];
            btn.title = light;
            btn.style = `width:32px;height:32px;margin-left:6px;border-radius:50%;border:2px solid #333;font-weight:bold;cursor:pointer;background:${light==='RED'?'#e53935':light==='YELLOW'?'#fbc02d':'#43a047'};color:#fff;opacity:${manualStates[idx] ? 1 : 0.4};box-shadow:${manualStates[idx] ? '0 0 8px #fff' : 'none'};`;
            btn.onclick = () => {
                manualStates[idx] = manualStates[idx] ? 0 : 1;
                renderManualLights();
            };
            row.appendChild(btn);
        });
        manualLightsDiv.appendChild(row);
    });
}
renderManualLights();

// Toggle manual mode
manualModeBtn.onclick = () => {
    manualMode = !manualMode;
    manualControls.style.display = manualMode ? 'block' : 'none';
    manualModeBtn.textContent = manualMode ? 'ðŸ›  Manual Mode' : 'ðŸ”„ Auto Mode';
    if (!manualMode) {
        // Optionally send command to return to auto
        sendCommand('!resume');
    }
};

// Send manual command
manualSendBtn.onclick = () => {
    const delay = parseInt(manualDelayInput.value) || 1000;
    const statesStr = manualStates.map(x => x ? '1' : '0').join('');
    sendCommand(`!manual ${delay} ${statesStr}`);
};

// Optional: When switching to manual, reset manualStates
manualModeBtn.addEventListener('click', () => {
    if (manualMode) {
        manualStates = Array(15).fill(0);
        renderManualLights();
    }
});

        // Serial command send logic
    document.getElementById('serialSendBtn').addEventListener('click', function() {
        const cmd = document.getElementById('serialCommandInput').value.trim();
        if (cmd) {
            sendCommand(cmd);
            document.getElementById('serialCommandInput').value = '';
        }
    });
    document.getElementById('serialCommandInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('serialSendBtn').click();
        }
    });
    </script>
</body>
</html>